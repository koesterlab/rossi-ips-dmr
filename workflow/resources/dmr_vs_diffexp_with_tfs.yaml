__use_yte__: true


name: Diffexp vs DMRs
datasets:
  data_with_tfs:
    path: ?input.complete
    separator: "\t"
    links:
      data_with_tfs:
        column: row_id
        table-row: diffexp_vs_dmrs_table_with_tfs/row_id
  data_focus_tfs:
    path: ?input.focus_tfs
    separator: "\t"
default-view: diffexp_vs_dmrs_plot_with_tfs
views:


  diffexp_vs_dmrs_table_with_tfs:
    dataset: data_with_tfs
    desc: f"This table contains DMR statistics and differential expression results per gene and germ layer. The column ext_gene lists all genes included in the analysis. To identify transcription factor (TF)–target relationships, we used CollecTRI (https://academic.oup.com/nar/article/51/20/10934/7318114), which provides a curated set of transcription factors and their target genes.

      If a gene is regulated by one or more transcription factors, the column is_tf_target is set to TRUE, and the corresponding transcription factors are listed in the tfs column. To account for the influence of transcription factors on DNA methylation, we adjust the gene-level DMR by aggregating the DMRs of its associated transcription factors. Specifically, when multiple DMRs are present for a given transcription factor, their mean is calculated first; the resulting values are then summed across all transcription factors regulating the gene.

      At present, the gene-level p-values and q-values are not adjusted for transcription factor influence"
    render-table:
      columns:
        row_id:
          display-mode: hidden
        is_tf_target:
          plot:
            heatmap:
              scale: ordinal
              color-scheme: tableau20
        qval_diffexp:
          plot:
            heatmap:
              scale: linear
              range:
                - "#a1d99b"
                - "white"
                - "#fdae6b"
              domain:
                - 0
                - 0.05
                - 0.5
        qval_dmr:
          plot:
            heatmap:
              scale: linear
              range:
                - "#a1d99b"
                - "white"
                - "#fdae6b"
              domain:
                - 0
                - 0.05
                - 0.5
        mean_methylation_difference_tf_adjusted:
          plot:
            heatmap:
              scale: linear
              range:
                - "#e6550d"
                - "white"
                - "#6baed6"
              domain:
                - -1
                - 0
                - 1 
        diffexp:
          plot:
            heatmap:
              scale: linear
              range:
                - "#e6550d"
                - "white"
                - "#6baed6"
              domain:
                - -5
                - 0
                - 5
        diffexp_se:
          plot:
            heatmap:
              scale: linear
              range:
                - "white"
                - "#6baed6"
              domain:
                - 0
                - 2
        germ_layer:
          plot:
            heatmap:
              scale: ordinal
              color-scheme: category10
        ext_gene:
          display-mode: normal
          link-to-url: 
            geneontology: 
              url: https://www.genecards.org/cgi-bin/carddisp.pl?gene={ext_gene}
        
        ens_gene:
          display-mode: normal
          link-to-url: 
            geneontology: 
              url: https://useast.ensembl.org/Homo_sapiens/Gene/Summary?db=core;g={ens_gene}
        pval_diffexp:
          display-mode: hidden
        pval_dmr:
          display-mode: hidden


  diffexp_vs_dmrs_plot_with_tfs:
    dataset: data_with_tfs
    desc: |
      f"This scatter plot shows DMR values and differential expression results per gene and germ layer. To identify transcription factor–target relationships, we used CollecTRI (https://academic.oup.com/nar/article/51/20/10934/7318114), which provides a curated set of transcription factors (TFs) and their target genes. To account for TF regulation, the DMR value of a gene is adjusted by aggregating the DMRs of its associated TFs. When multiple DMRs are present for a single TF, their mean is calculated first, and these values are then summed across all TFs regulating the gene. 

      At present, p-values and q-values are not modified for genes influenced by TFs. The displayed point opacity reflects the combined q-value, defined as the maximum of the q-values from the DMR and differential expression analyses of the target gene.

      The germ layer legend can be used to filter the plot by specific germ layers. Clicking on an individual data point reveals detailed information for the corresponding gene in an accompanying table."
    render-plot:
      spec: |
        {
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
          "config": {"view": {"continuousWidth": 500, "continuousHeight": 500}},
          "mark": {"type": "point", "filled": true},
          "encoding": {
            "color": {
              "condition": {
                "param": "Germ Layer",
                "field": "germ_layer",
                "scale": {"scheme": "category10"},
                "title": "Germ Layer",
                "type": "nominal"
              },
              "value": "lightgray"
            },
            "opacity": {
              "field": "qval_combined",
              "scale": {"range": [1, 0.1]},
              "title": "max(qval1, qval2)",
              "type": "quantitative"
            },
            "size": {
              "field": "qval_combined",
              "scale": {"range": [30, 1]},
              "title": "max(qval1, qval2)",
              "type": "quantitative"
            },
            "tooltip": [
              {"field": "ext_gene", "type": "nominal"},
              {"field": "ranked_meth_diffexp", "type": "quantitative"},
            ],
            "x": {"field": "diffexp", "scale": {"domain": [-5, 5]}, "type": "quantitative"},
            "y": {"field": "mean_methylation_difference_tf_adjusted", "scale": {"domain": [-1, 1]}, "type": "quantitative"},
            "href": {"field": "data_with_tfs"},
          },
          "params": [
            {
              "name": "Germ Layer",
              "select": {"type": "point", "fields": ["germ_layer"]},
              "bind": "legend"
            },
            {
              "name": "qval_max",
              "bind": {
                "input": "range",
                "max": 1,
                "min": 0,
                "name": "max qval: ",
                "step": 0.01
              },
              "value": 0.5
            }
          ],
          "transform": [{"filter": "(datum.qval_combined <= qval_max)"}],
        }



  tfs_only:
    dataset: data_focus_tfs
    desc: | 
      f"Scatter plot with DMR values and DiffExp per transcription factor and germ_layer. We show only transcription factors with target genes included in our analysis. We show 'qval combined' (the maximum of the qvalues of the DMR and DiffExp analysis) as opacity of each data point. You can click on the Germ Layer legend to filter on specific germ layers.
      Point opacity represents the combined q-value, defined as the maximum of the q-values from the DMR and differential expression analyses; lower opacity therefore indicates weaker statistical support. The germ layer legend can be used to interactively filter the plot to specific germ layers."
    render-plot:
      spec: |
        {
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
          "config": {"view": {"continuousWidth": 500, "continuousHeight": 500}},
          "mark": {"type": "point", "filled": true},
          "encoding": {
            "color": {
              "condition": {
                "param": "Germ Layer",
                "field": "germ_layer",
                "scale": {"scheme": "category10"},
                "title": "Germ Layer",
                "type": "nominal"
              },
              "value": "lightgray"
            },
            "opacity": {
              "field": "qval_combined",
              "scale": {"range": [1, 0.1]},
              "title": "max(qval1, qval2)",
              "type": "quantitative"
            },
            "size": {
              "field": "qval_combined",
              "scale": {"range": [30, 1]},
              "title": "max(qval1, qval2)",
              "type": "quantitative"
            },
            "tooltip": [
              {"field": "tfs", "type": "nominal"},
              {"field": "diffexp", "type": "quantitative"},
              {"field": "mean_methylation_difference", "type": "quantitative"},
              {"field": "qval_combined", "type": "quantitative"},
              {"field": "qval_diffexp", "type": "quantitative"},
              {"field": "qval_dmr", "type": "quantitative"}
            ],
            "x": {"field": "diffexp", "type": "quantitative"},
            "y": {"field": "mean_methylation_difference", "type": "quantitative"}
          },
          "params": [
            {
              "name": "Germ Layer",
              "select": {"type": "point", "fields": ["germ_layer"]},
              "bind": "legend"
            }
          ], 
                
        }
      